<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlareGuard | Fire Detection System</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #ff4d4d;
            --primary-dark: #cc0000;
            --secondary: #2c3e50;
            --light: #ecf0f1;
            --dark: #1a1a1a;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --card-bg: rgba(255, 255, 255, 0.08);
            --card-border: rgba(255, 255, 255, 0.1);
        }

        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--secondary);
            color: var(--light);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: auto;
            padding: 3rem 2rem;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
        }

        h1 {
            font-size: 2.8rem;
            margin-bottom: 0.8rem;
            background: linear-gradient(45deg, var(--primary), var(--warning));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            letter-spacing: 1px;
        }

        .tagline {
            font-size: 1.2rem;
            opacity: 0.9;
            font-weight: 300;
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            padding: 2.5rem;
            margin-bottom: 2.5rem;
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }

        .card h2 {
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            color: var(--light);
        }

        .card p {
            font-size: 1.05rem;
            margin-bottom: 2rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .form-group { 
            margin-bottom: 2rem; 
        }

        label {
            display: block;
            margin-bottom: 0.8rem;
            font-weight: 600;
            font-size: 1.05rem;
            color: rgba(255, 255, 255, 0.9);
        }

        input {
            width: 100%;
            padding: 1.1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--light);
            font-size: 1rem;
        }

        input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 77, 77, 0.4);
            box-shadow: 0 0 0 3px rgba(255, 77, 77, 0.2);
        }

        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 1.2rem 2rem;
            border-radius: 10px;
            font-size: 1.05rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: background 0.3s ease;
        }

        button:hover {
            background: var(--primary-dark);
        }

        button:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .status-container { 
            display: none; 
            text-align: center;
        }

        .status-indicator {
            width: 220px;
            height: 220px;
            border-radius: 50%;
            margin: 0 auto 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem;
            font-weight: 600;
            border: 8px solid rgba(255, 255, 255, 0.1);
        }

        .safe { 
            background: var(--success);
            box-shadow: 0 0 30px rgba(46, 204, 113, 0.3);
        }

        .warning { 
            background: var(--warning);
            box-shadow: 0 0 30px rgba(243, 156, 18, 0.3);
            animation: pulse 2s infinite;
        }

        .danger { 
            background: var(--danger);
            box-shadow: 0 0 30px rgba(231, 76, 60, 0.4);
            animation: alarm 0.8s infinite alternate;
        }

        .sensor-data {
            display: flex;
            justify-content: space-around;
            margin: 3rem 0;
            gap: 1.5rem;
        }

        .sensor-box {
            background: rgba(0, 0, 0, 0.15);
            padding: 1.5rem;
            border-radius: 12px;
            min-width: 160px;
            flex: 1;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .sensor-box div:first-child {
            font-size: 1rem;
            opacity: 0.8;
            margin-bottom: 0.8rem;
        }

        .sensor-value {
            font-size: 2rem;
            font-weight: 600;
        }

        #status-message {
            font-size: 1.2rem;
            margin-top: 1rem;
            padding: 1.2rem;
            border-radius: 8px;
        }

        .status-safe {
            background: rgba(46, 204, 113, 0.1);
            color: #6bff9e;
        }

        .status-warning {
            background: rgba(243, 156, 18, 0.1);
            color: #ffd166;
        }

        .status-danger {
            background: rgba(231, 76, 60, 0.15);
            color: #ff6b6b;
        }

        .config-status {
            margin-top: 1.5rem;
            text-align: center;
            padding: 1rem;
            border-radius: 8px;
            font-weight: 500;
        }

        .error {
            background: rgba(231, 76, 60, 0.2);
            color: #ff6b6b;
        }

        .loading {
            background: rgba(52, 152, 219, 0.2);
            color: #6bb9ff;
        }

        .success {
            background: rgba(46, 204, 113, 0.2);
            color: #6bff9e;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.03); }
            100% { transform: scale(1); }
        }

        @keyframes alarm {
            0% { transform: scale(1); }
            100% { transform: scale(1.05); }
        }

        @media (max-width: 768px) {
            .container {
                padding: 2rem 1.5rem;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .card {
                padding: 2rem 1.5rem;
            }
            
            .sensor-data {
                flex-direction: column;
                gap: 1rem;
            }
            
            .status-indicator {
                width: 180px;
                height: 180px;
                font-size: 1.4rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>FlareGuard</h1>
            <p class="tagline">Advanced Fire Detection System</p>
        </header>

        <div class="card" id="configCard">
            <h2>WiFi Configuration</h2>
            <p>Please enter your WiFi credentials to connect the device</p>
            
            <div class="form-group">
                <label for="wifi-ssid">WiFi Network Name (SSID)</label>
                <input type="text" id="wifi-ssid" placeholder="Enter your WiFi SSID" required>
            </div>
            
            <div class="form-group">
                <label for="wifi-password">WiFi Password</label>
                <input type="password" id="wifi-password" placeholder="Enter your WiFi password" required>
            </div>
            
            <button id="connectBtn">Connect Device</button>
            <div id="configStatus" class="config-status"></div>
        </div>

        <div class="card status-container" id="statusCard">
            <h2>Fire Detection Status</h2>
            
            <div class="status-indicator safe" id="statusIndicator">
                System Ready
            </div>
            
            <div class="sensor-data">
                <div class="sensor-box">
                    <div>Smoke Level</div>
                    <div class="sensor-value" id="smokeValue">0</div>
                </div>
                
                <div class="sensor-box">
                    <div>Flame Detected</div>
                    <div class="sensor-value" id="flameValue">No</div>
                </div>
            </div>
            
            <p id="statusMessage" class="status-safe">Awaiting sensor data...</p>
            
        </div>
    </div>

    <audio id="alarmAudio">
        <source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" type="audio/ogg">
    </audio>

    <script>
        // MQTT Configuration
        const mqttBroker = 'wss://test.mosquitto.org:8081/mqtt'; // Public MQTT broker
        let mqttClient = null;
        let pendingWifiCredentials = null;

        // DOM Elements
        const configCard = document.getElementById('configCard');
        const statusCard = document.getElementById('statusCard');
        const connectBtn = document.getElementById('connectBtn');
        const reconfigureBtn = document.getElementById('reconfigureBtn');
        const configStatus = document.getElementById('configStatus');
        const wifiSsidInput = document.getElementById('wifi-ssid');
        const wifiPasswordInput = document.getElementById('wifi-password');
        const statusIndicator = document.getElementById('statusIndicator');
        const smokeValue = document.getElementById('smokeValue');
        const flameValue = document.getElementById('flameValue');
        const statusMessage = document.getElementById('statusMessage');
        const alarmAudio = document.getElementById('alarmAudio');

        // Thresholds
        const smokeThreshold = 400;

        // Initialize MQTT Connection
        function initializeMqtt() {
            if (mqttClient && mqttClient.connected) {
                return;
            }

            mqttClient = mqtt.connect(mqttBroker);

            mqttClient.on('connect', () => {
    console.log('✅ Connected to MQTT broker');
    configStatus.textContent = '✅ Connected to MQTT broker';
    configStatus.className = 'config-status success';
    
    // Subscribe
    mqttClient.subscribe('fireDetection/status');
    mqttClient.subscribe('fireDetection/mq2');
    mqttClient.subscribe('fireDetection/flame');
    
    console.log('✅ Subscribed to topics');

    // Send pending WiFi credentials if any
    if (pendingWifiCredentials) {
        sendWifiCredentials(pendingWifiCredentials.ssid, pendingWifiCredentials.password);
        pendingWifiCredentials = null;
    }
});


            mqttClient.on('message', (topic, message) => {
                const msg = message.toString();
                console.log(`📩 ${topic} → ${msg}`);

                if (topic === 'fireDetection/status') {
                    handleStatusMessage(msg);
                } else if (topic === 'fireDetection/mq2') {
                    handleSmokeMessage(msg);
                } else if (topic === 'fireDetection/flame') {
                    handleFlameMessage(msg);
                }
            });

            mqttClient.on('error', (error) => {
                console.error('MQTT Error:', error);
                configStatus.textContent = '❌ MQTT Connection Error';
                configStatus.className = 'config-status error';
                connectBtn.disabled = false;
            });

            mqttClient.on('close', () => {
                console.log('MQTT Connection closed');
                configStatus.textContent = '⚠️ MQTT Connection Closed';
                configStatus.className = 'config-status loading';
            });
        }

        // Handle status messages
        function handleStatusMessage(msg) {
            if (msg === 'connected') {
                configCard.style.display = 'none';
                statusCard.style.display = 'block';
            } else if (msg === 'wifi_failed') {
                configStatus.textContent = '❌ WiFi connection failed. Check credentials.';
                configStatus.className = 'config-status error';
                connectBtn.disabled = false;
            } else if (msg === 'wifi_success') {
                configStatus.textContent = '✅ WiFi credentials received by device';
                configStatus.className = 'config-status success';
                setTimeout(() => {
                    configCard.style.display = 'none';
                    statusCard.style.display = 'block';
                }, 2000);
            }
        }

        // Handle smoke sensor messages
        function handleSmokeMessage(msg) {
            const smoke = parseInt(msg);
            smokeValue.textContent = smoke;
            
            if (smoke > smokeThreshold) {
                updateStatus('⚠️ Elevated smoke levels detected', 'warning');
            } else if (flameValue.textContent === 'No') {
                updateStatus('✅ Environment normal', 'safe');
            }
        }

        // Handle flame sensor messages
        function handleFlameMessage(msg) {
            const fire = msg === '1';
            flameValue.textContent = fire ? 'Yes' : 'No';
            
            if (fire) {
                updateStatus('🔥 CRITICAL: Fire detected!', 'danger');
                alarmAudio.play().catch(e => console.log('Audio play failed:', e));
            } else if (parseInt(smokeValue.textContent) <= smokeThreshold) {
                updateStatus('✅ Environment normal', 'safe');
                alarmAudio.pause();
                alarmAudio.currentTime = 0;
            }
        }

        // Update status display
        function updateStatus(text, level) {
            statusMessage.textContent = text;
            statusMessage.className = `status-${level}`;
            
            // Update status indicator
            statusIndicator.className = `status-indicator ${level}`;
            statusIndicator.textContent = text.split(':')[0]; // Show only the first part
        }

        // Send WiFi credentials to device
        function sendWifiCredentials(ssid, password) {
    if (!mqttClient || !mqttClient.connected) {
        console.warn("MQTT client not connected yet. Storing credentials.");
        pendingWifiCredentials = { ssid, password };
        initializeMqtt();
        return;
    }

    const wifiPayload = `${ssid},${password}`;
    console.log('📡 Sending Wi-Fi credentials to topic: fireDetection/wifi');
    console.log('📦 Payload:', wifiPayload);

    mqttClient.publish('fireDetection/wifi', wifiPayload, { qos: 0, retain: false }, (err) => {
        if (err) {
            console.error('❌ Error publishing WiFi credentials:', err);
            configStatus.textContent = '❌ Failed to send credentials';
            configStatus.className = 'config-status error';
            connectBtn.disabled = false;
        } else {
            console.log('✅ WiFi credentials published successfully!');
            configStatus.textContent = '⏳ Sending credentials to device...';
            configStatus.className = 'config-status loading';
        }
    });
}


        // Handle connect button click
        connectBtn.addEventListener('click', () => {
    const ssid = wifiSsidInput.value.trim();
    const password = wifiPasswordInput.value.trim();

    if (!ssid || !password) {
        configStatus.textContent = '❌ SSID and Password are required';
        configStatus.className = 'config-status error';
        return;
    }

    configStatus.textContent = '⏳ Connecting to MQTT broker...';
    configStatus.className = 'config-status loading';
    connectBtn.disabled = true;

    // Initialize MQTT (it will call sendWifiCredentials inside on connect)
    pendingWifiCredentials = { ssid, password };
    initializeMqtt();
});

        // Always show configuration card on page load
        window.addEventListener('load', () => {
            configCard.style.display = 'block';
            statusCard.style.display = 'none';
        });
    </script>

<script>
  document.addEventListener('keydown', function(e) {
      // Block F12
      if (e.key === "F12") {
        e.preventDefault();
      }

      // Block Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+Shift+C
      if (e.ctrlKey && e.shiftKey && ['I', 'J', 'C'].includes(e.key.toUpperCase())) {
        e.preventDefault();
      }

      // Block Ctrl+U
      if (e.ctrlKey && e.key.toUpperCase() === 'U') {
        e.preventDefault();
      }
    });

    // Disable text selection
    document.addEventListener('selectstart', function(e) {
      if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
        e.preventDefault();
      }
    });

    // Disable image dragging
    document.addEventListener('dragstart', function(e) {
      if (e.target.tagName === 'IMG') {
        e.preventDefault();
      }
    });

    // Disable right-click on images
    document.querySelectorAll('img').forEach(img => {
      img.addEventListener('contextmenu', e => e.preventDefault());
    });
</script>

</body>
</html>
